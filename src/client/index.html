<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DM Vault</title>
  <link rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 16 16%27%3E%3Ccircle cx=%278%27 cy=%278%27 r=%277%27 fill=%27%238b5cf6%27/%3E%3C/svg%3E" />

  <!-- Core theme/styles (copied from your current build to preserve the look) -->
  <link rel="stylesheet" href="/assets/style.css" />
  <link rel="stylesheet" href="/assets/components.css" />
  <link rel="stylesheet" href="/assets/sidebar.css" />
  <link rel="stylesheet" href="/assets/enhanced-todo.css" />
  <link rel="stylesheet" href="/assets/modal.css" />
  <link rel="stylesheet" href="/assets/lightbox.css" />
  <link rel="stylesheet" href="/assets/landing-pages.css" />

  <!-- Optional per-user overrides (lives in the user's data volume). 404 is fine. -->
  <link rel="stylesheet" href="/user/custom.css" />

  <script>window.SITE_BASE = "/"</script>
</head>

<body>
  <div class="layout">
    <!-- TOP TOOLBAR (global) -->
    <div class="top">
      <div class="toolbar">
        <a class="chip" href="/" data-link>Hembr√§nt</a>
        <a class="chip" href="/session" data-link>Session</a>
        <button id="btnCreatePage" class="chip" title="Create New Page">+ New</button>
        <button id="btnEditPage" class="chip" title="Edit This Page" disabled>Edit</button>
      </div>
      <div class="search">
        <input id="searchBox" type="search" placeholder="Search titles, headings, #tags (Cmd/Ctrl-K)" />
      </div>
      <div id="themeModeSwitch" style="display:flex; gap:6px; align-items:center;">
        <button id="themeModeDark" class="chip" aria-pressed="true" title="Dark mode">Dark</button>
        <button id="themeModeLight" class="chip" aria-pressed="false" title="Light mode">Light</button>
      </div>
      <div id="searchResults" class="hovercard"></div>
    </div>



    <!-- LEFT NAV (global) -->
    <aside class="left">
      <div class="drawer" aria-label="Navigation">
        <div class="drawer-handle">
          <button id="leftDrawerToggle" class="chip" aria-expanded="true" aria-controls="leftDrawer">Nav</button>
          <button id="leftCollapseExpand" class="chip" title="Collapse/Expand All">Collapse all</button>
        </div>

        <div id="leftDrawer" class="drawer-content">
          <aside class="sidebar" role="navigation">
            <div class="campaign-header">
              <div class="campaign-title">Feywild Adventures</div>
            </div>

            <nav class="nav">
              <a class="nav-item nav-dashboard" href="/" data-link>
                <span class="nav-icon">üè†</span><span class="nav-text">Dashboard</span>
              </a>

              <div class="nav-quick"><input id="navQuick" placeholder="Quick nav..." /></div>

              <details class="nav-details" data-section="other" open>
                <summary class="nav-label nav-section-header"><span class="nav-icon">‚≠ê</span><span>Favorites</span></summary>
                <ul id="navFav" class="nav-list"></ul>
              </details>

              <ul id="navSections" class="nav-sections"></ul>
            </nav>

            <!-- Weather card placeholder (hook later) -->
            <div id="weatherCard" class="card weather-card" aria-label="Weather" hidden>
              <div class="weather-header">
                <div class="weather-title">Weather</div>
                <button id="rollWeather" class="chip" title="Roll weather">Roll</button>
              </div>
            </div>

            <!-- Bottom-left mini app mount (Settings lives here) -->
            <div id="leftPanelBottomApp" class="card" style="margin-top: 10px;"></div>
          </aside>
        </div>
      </div>
    </aside>

    <!-- Left edge resizer -->
    <div class="resizer resizer-left" aria-label="Resize navigation" role="separator" aria-orientation="vertical"
      tabindex="0"></div>

    <!-- MAIN CONTENT OUTLET (dynamic) -->
    <main class="main">
      <div class="breadcrumb-container">
        <div id="breadcrumbText" class="main-breadcrumb meta"></div>
        <button id="btnDeletePage" class="delete-page-btn" title="Delete this page" aria-label="Delete this page"
          hidden>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" />
          </svg>
        </button>
      </div>

      <div id="outlet"></div>
    </main>

    <!-- RIGHT PANEL (global; placeholder for now) -->
    <aside class="right">
      <div class="right-drawer" aria-label="Side panel">
        <div class="right-drawer-handle">
          <button id="rightDrawerToggle" class="chip" aria-expanded="false">Tools</button>
          <button id="rightTopAppNotes" class="chip panelToggle" type="button" title="Show Notes">Notes</button>
          <button id="rightTopAppConditions" class="chip panelToggle" type="button" title="Show Conditions">Conditions</button>
          <button id="rightTopAppHp" class="chip panelToggle" type="button" title="Show HP Tracker">HP</button>
          <button id="rightTopAppRandomOcc" class="chip panelToggle" type="button" title="Show Random Occurrences">Random</button>
        </div>

        <div id="rightDrawer" class="right-drawer-content" hidden>
          <div class="right-panel-tabs">
            <!-- Deprecated: legacy tab buttons kept for JS hooks; hidden for new picker UX -->
            <button class="chip" data-tab="notepad" hidden>Notepad</button>
            <button class="chip" data-tab="conditions" hidden>Conditions</button>
            <button class="chip" data-tab="todo" hidden>To-Do</button>
            <button class="chip" data-tab="randomOcc" hidden>Random</button>
            <button class="chip" data-tab="backlinks" hidden>Backlinks</button>
            <button class="chip" data-tab="settings" hidden>Settings</button>
            <button id="rightSplitToggle" class="chip" aria-pressed="false" title="Split view" hidden>Split</button>
            <!-- Deprecated close button removed: use the top "Tools" toggle -->
          </div>

          <details id="rightPanelControls">
            <summary>Panel controls</summary>
            <div id="rightPanelControlsBody">
          <div id="rightSplitPicker" class="right-split-picker">
            <span class="meta">Mode</span>
            <select id="rightPanelModeSelect">
              <option value="single">Single</option>
              <option value="split">Split</option>
            </select>

            <div id="rightSingleGroup" style="display:flex;gap:8px;align-items:center;">
              <span class="meta">Panel</span>
              <select id="rightPanelSingleSelect">
                <option value="notepad">Notepad</option>
                <option value="conditions">Conditions</option>
                <option value="todo">To-Do</option>
                <option value="randomOcc">Random Occurrences</option>
                <option value="backlinks">Backlinks</option>
                <option value="settings">Settings</option>
              </select>
            </div>

            <div id="rightSplitGroup" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <span class="meta">Top</span>
              <select id="rightSplitTopSelect">
                <option value="notepad">Notepad</option>
                <option value="todo">To-Do</option>
                <option value="conditions">Conditions</option>
                <option value="hp">HP</option>
                <option value="randomOccurrences">Random</option>
                <option value="backlinks">Backlinks</option>
              </select>
              <span class="meta">Bottom</span>
              <select id="rightSplitBottomSelect">
                <option value="notepad">Notepad</option>
                <option value="todo">To-Do</option>
                <option value="conditions">Conditions</option>
                <option value="hp">HP</option>
                <option value="randomOccurrences">Random</option>
                <option value="backlinks">Backlinks</option>
              </select>
              <button id="rightSplitSwap" class="chip" type="button" title="Swap">‚áÖ</button>
            </div>
          </div>
            </div>
          </details>

          <section class="right-panel" data-panel="notepad">
            <h3 class="meta">Notepad</h3>
            <div id="rightNotepadSlot">
              <textarea id="notepad" placeholder="Notes live in your local vault..."></textarea>
              <div id="rightNotepadMount" class="split-mount" hidden></div>
            </div>
          </section>

          <section class="right-panel" data-panel="conditions" hidden>
            <h3 class="meta">Conditions</h3>
            <div id="rightConditionsSlot">
              <p class="meta">Loading‚Ä¶</p>
            </div>
          </section>

          <div id="rightSplitHandle" role="separator" aria-orientation="horizontal" tabindex="0"></div>

          <section class="right-panel" data-panel="todo" hidden>
            <h3 class="meta">To-Do</h3>
            <div id="rightTodoSlot">
              <div id="todoNative">
                <div class="todo-row">
                  <input id="todoInput" placeholder="Add a task" />
                  <button id="todoAdd" class="chip">Add</button>
                </div>
                <ul id="todoList"></ul>
              </div>
              <div id="rightTodoMount" class="split-mount" hidden></div>
            </div>
          </section>

          <section class="right-panel" data-panel="randomOcc" hidden>
            <h3 class="meta">Random Occurrences</h3>
            <div id="rightRandomOccSlot">
              <div id="randomOccNative">
                <div class="todo-row">
                  <input id="randomOccInput" placeholder="Add a random occurrence" />
                  <button id="randomOccAdd" class="chip">Add</button>
                </div>
                <ul id="randomOccList"></ul>
              </div>
              <div id="rightRandomOccMount" class="split-mount" hidden></div>
            </div>
          </section>

          <section class="right-panel" data-panel="backlinks" hidden>
            <h3 class="meta">Backlinks</h3>
            <ul id="backlinksList"></ul>
            <p id="backlinksEmpty" class="meta" hidden>No backlinks yet</p>
          </section>

          <section class="right-panel" data-panel="settings" hidden>
            <h3 class="meta">Settings</h3>
            <div id="settingsPanel"></div>
          </section>
        </div>
      </div>
    </aside>

    <!-- Right edge resizer -->
    <div class="resizer resizer-right" aria-label="Resize tools" role="separator" aria-orientation="vertical"
      tabindex="0"></div>

    <!-- Reveal tabs (shown when collapsed via CSS) -->
    <button class="left-drawer-tab" aria-label="Open navigation" hidden>Nav</button>
    <button class="drawer-tab" aria-label="Open tools" hidden>Tools</button>

    <!-- FOOTER (global) -->
    <footer class="footer">
      <div class="meta">¬© <span id="year"></span> Feywild Adventures</div>
    </footer>
  </div>

  <!-- Modals (global) -->
  <div class="modal" id="createPageModal" tabindex="-1" aria-modal="true" style="display:none;">
    <div class="modal-content">
      <h2>Create New Page</h2>
      <form>
        <label>Create
          <select name="createKind">
            <option value="page" selected>Page</option>
            <option value="section">Section</option>
          </select>
        </label>
        <label data-create-row="pageType">Type
          <select name="pageType">
            <option value="note">Note</option>
            <option value="npc">NPC</option>
            <option value="character">Character</option>
            <option value="location">Location</option>
            <option value="arc">Arc</option>
            <option value="tool">Tool</option>
          </select>
        </label>
        <label><span data-title-label>Title</span>
          <input name="pageTitle" type="text" required autocomplete="off" />
        </label>
        <div class="modal-actions">
          <button type="button" class="modal-cancel">Cancel</button>
          <button type="button" class="modal-confirm">Create</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="deletePageModal" tabindex="-1" aria-modal="true" style="display:none;">
    <div class="modal-content">
      <h2>Delete Page</h2>
      <p>Are you sure? This cannot be undone.</p>
      <p>Type the page title to confirm: <strong class="delete-page-title-label"></strong></p>
      <input name="deleteConfirmTitle" type="text" autocomplete="off" />
      <div class="modal-actions">
        <button type="button" class="modal-cancel">Cancel</button>
        <button type="button" class="modal-confirm" disabled>Delete</button>
      </div>
    </div>
  </div>

  <div class="modal" id="wikilinkCreateModal" tabindex="-1" aria-modal="true" style="display:none;">
    <div class="modal-content">
      <h2>Resolve Wikilink</h2>
      <p>Wikilink: <strong class="wikilink-title-label"></strong></p>

      <div class="wiki-resolve">
        <h3 style="margin: 10px 0 4px;">Link to existing</h3>
        <input name="wikiResolveQuery" type="text" placeholder="Search pages‚Ä¶" autocomplete="off" />
        <div class="wikiResolveAuto" style="margin: 6px 0; display:none;"></div>
        <div class="wikiResolveResults" style="max-height: 240px; overflow:auto; border: 1px solid var(--border); border-radius: 8px; padding: 4px;"></div>
        <div class="wikiSelectedSummary" aria-live="polite">No page selected</div>
      </div>

      <div class="wiki-apply" style="margin-top: 12px;">
        <h3 style="margin: 10px 0 4px;">Scope</h3>
        <div class="wiki-scope-group" role="radiogroup" aria-label="Scope">
          <label style="display:block; margin: 6px 0;">
            <input type="radio" name="wikiScope" value="single" checked /> Only this link (recommended)
          </label>
          <label style="display:block; margin: 6px 0;">
            <input type="radio" name="wikiScope" value="page" /> All occurrences in this page
          </label>
          <label style="display:block; margin: 6px 0;">
            <input type="radio" name="wikiScope" value="vault" /> Across the vault‚Ä¶
          </label>
        </div>
        <div class="wikiScopeReview" style="display:none; margin-top: 6px;">
          <span class="wikiScopeStatus" style="margin-right:6px; color: var(--muted);">Click Review pages‚Ä¶ to calculate scope</span>
          <button type="button" class="wikiScopeReviewBtn" style="font-size: 12px;">Review pages‚Ä¶</button>
          <div class="wikiApplyList" style="display:none; max-height: 180px; overflow:auto; border: 1px solid var(--border); border-radius: 8px; padding: 6px; margin-top: 6px;"></div>
        </div>
      </div>

      <div class="wiki-create" style="margin-top: 12px;">
        <h3 style="margin: 10px 0 4px;">Create new page</h3>
        <label>Type
          <select name="wikiCreateType">
            <option value="note">Note</option>
            <option value="npc">NPC</option>
            <option value="character">Character</option>
            <option value="location">Location</option>
            <option value="arc">Arc</option>
            <option value="tool">Tool</option>
          </select>
        </label>
        <div class="modal-actions">
          <button type="button" class="modal-cancel">Cancel</button>
          <button type="button" class="modal-confirm">Create</button>
        </div>
      </div>

      <div class="wikiFooter">
        <button type="button" id="wikiCancel" class="btn-secondary">Cancel</button>
        <button type="button" id="wikiConfirm" class="btn-primary" disabled>Link</button>
      </div>
    </div>
  </div>

  <div class="modal" id="open5eSpellModal" tabindex="-1" aria-modal="true" style="display:none;">
    <div class="modal-content" style="max-width:720px;">
      <h2>Link Open5e</h2>
      <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
        <label>
          Type
          <select name="open5eType">
            <option value="spell">Spell</option>
            <option value="creature">Creature</option>
            <option value="monster">Monsters</option>
            <option value="condition">Condition</option>
            <option value="item">Magic Item</option>
            <option value="weapon">Weapon</option>
            <option value="armor">Armor</option>
          </select>
        </label>
        <label style="flex:1; min-width:240px;">
          Query
          <input name="open5eSpellQuery" type="text" placeholder="Search Open5e‚Ä¶" autocomplete="off" />
        </label>
        <label style="display:flex; align-items:center; gap:8px; margin:6px 0;">
          <input type="checkbox" name="open5eSpellAllSources" />
          <span>Search all sources</span>
        </label>
      </div>
      <div class="o5eSpellHint" style="font-size:12px; color: var(--muted); min-height: 16px;"></div>
      <div style="display:flex; gap:10px;">
        <div class="o5eSpellResults" style="flex:1; min-width: 0; max-height: 260px; overflow:auto; border: 1px solid var(--border); border-radius: 8px; padding: 4px;"></div>
        <div class="o5eSpellPreview hovercard" style="position:static; display:block; pointer-events:auto; max-width:none; min-width: 260px; flex:1;"></div>
      </div>
      <div class="modal-actions" style="display:flex; gap:8px; align-items:center;">
        <button type="button" class="modal-cancel">Cancel</button>
        <button type="button" class="btn modal-link-all" disabled>Link all occurrences</button>
        <button type="button" class="modal-confirm" disabled>Link</button>
      </div>
    </div>
  </div>

  <!-- Open5e Spell Details Modal -->
  <div class="modal" id="open5eSpellDetailsModal" tabindex="-1" aria-modal="true" style="display:none;">
    <div class="modal-inner wide" style="background: var(--panel); color: var(--text); max-width: 720px;">
      <div class="modal-header">
        <h2 id="open5eSpellDetailsTitle">Spell</h2>
        <button class="btn" data-close>Close</button>
      </div>
      <div class="modal-body" id="open5eSpellDetailsBody" style="overflow-y:auto; max-height:60vh;">
        <!-- filled by JS -->
      </div>
    </div>
  </div>

  <!-- Open5e Link Modal (for o5e links click) -->
  <div class="modal" id="open5eLinkModal" tabindex="-1" aria-modal="true" style="display:none;">
    <div class="modal-content" style="max-width:520px;">
      <h2 id="open5eLinkTitle">Open5e</h2>
      <div class="o5eLinkMeta meta" id="open5eLinkMeta" style="margin:6px 0 12px;"></div>
      <div class="o5eLinkActions" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label style="display:flex; align-items:center; gap:6px;">
          <span class="meta">Section</span>
          <select id="o5eLinkSectionSelect">
            <option value="note">Note</option>
            <option value="npc">NPC</option>
            <option value="character">Character</option>
            <option value="location">Location</option>
            <option value="arc">Arc</option>
            <option value="tool">Tool</option>
          </select>
        </label>
        <button type="button" class="btn btn-primary" id="o5eCreatePageBtn">Create new page</button>
        <button type="button" class="btn" id="o5eOpenJsonBtn">See stats on Open5e</button>
        <button type="button" class="btn" id="o5eOpenExistingBtn" style="display:none;">Open existing page</button>
      </div>
      <div class="modal-actions" style="margin-top:12px;">
        <button type="button" class="modal-cancel">Close</button>
      </div>
    </div>
  </div>

  <!-- Inline Comment Modal (styled similar to spell details modal) -->
  <div class="modal" id="inlineCommentModal" tabindex="-1" aria-modal="true" style="display:none;">
    <div class="modal-inner" style="background: var(--panel); color: var(--text); max-width: 560px;">
      <div class="modal-header">
        <h2 class="inlineCommentTitle">Add Comment</h2>
        <button class="btn modal-cancel" data-close>Close</button>
      </div>
      <div class="modal-body" style="overflow-y:auto; max-height:60vh;">
        <div style="font-size:12px; color: var(--muted); margin-bottom:6px;">On: <span class="inlineCommentLabel"></span></div>
        <label style="display:block;">
          <div style="font-size:12px; opacity:.8; margin-bottom:4px;">Comment</div>
          <textarea name="inlineCommentText" style="width:100%; min-height: 120px;"></textarea>
        </label>
        <div class="modal-actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
          <button type="button" class="btn modal-delete" style="display:none;">Delete</button>
          <button type="button" class="btn modal-cancel">Cancel</button>
          <button type="button" class="btn btn-primary modal-confirm">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Error Modal -->
  <div class="modal" id="uploadErrorModal" tabindex="-1" aria-modal="true" style="display:none;">
    <div class="modal-content">
      <h2>Image upload failed</h2>
      <p class="upload-error-message">Image upload failed.</p>
      <div class="modal-actions">
        <button type="button" class="modal-confirm">OK</button>
      </div>
    </div>
  </div>

  <script type="module" src="/app.js"></script>
  <div id="partyDrawerRoot"></div>
</body>

</html>
